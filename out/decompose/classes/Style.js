import{ELEMENT,SHEET,RULES,QUERIES}from"../consts/symbols.js";import{PROXY}from"../consts/proxy.js";import{tError}from"../tError.js";function ampersander(e,s,t){let r=s;for(;r.match(e);)r=r.replace(e,t);return r}function globalApplier(e){let s=ampersander(/([a-zA-Z0-9.:#\[="\]~>+ ,]+)(?:\s+{)((?:\s*(?:[a-zA-Z0-9-]+):.+;)*)(\s*@[a-zA-Z0-9: ()%&]+\s*{\s*)(?:\s*)(\s*[&a-zA-Z0-9.:#\[="\]~>+ ,]+)(?:\s+{)((?:(?:\s*(?:[a-zA-Z0-9-]+):.+;)|(?:\s*&[^&{}]+{[^}]+}))*\s*})/,e,replacer1);return s=ampersander(/@[a-zA-Z0-9: ()%&]+\s*{\s*\s*}/g,s,(()=>"")),s=ampersander(/^\s*([a-zA-Z0-9.:#\[="\]~>+ ,]+)(?:\s+{)((?:\s*(?:[a-zA-Z0-9-]+):.+;)*)(?:\s*)(\s*[&a-zA-Z0-9.:#\[="\]~>+ ,]+)(?:\s+{)((?:(?:\s*(?:[a-zA-Z0-9-]+):.+;)|(?:\s*&[^&{}]+{[^}]+}))*\s*})/m,s,replacer2),console.log(s),s}export class DeStyle{static get regex(){return{nestRegularize:/(@nest)([^{\n]+{[^}]+})/g,nesting:/(^|;|})\s*([\w-.#:[="\]~>+ ,*]*[\w-\]*])(?:\s*{)((?:\s*(?:[\w-]+):[^;]+;)*)(?:\s*)(\s*[&\w-.#:[="\]~>+ ,*]*[\w-\]*])(?:\s*{)((?:(?:\s*(?:[\w-]+):[^;]+;)|(?:\s*&[^{}]+{[\s\S]*?}))*\s*})/,cleanup:/@[\w-:( )%&]+\s*{\s*\s*}/g,nestCleanup:/(@nest\s?{\s?)(?:(?:|[^{}]|{[^{}]*})+)(\s})/g,queries:/([\w-.#:[="\]~>+ ,*]*[\w-\]*])(?:\s*{)((?:(?:[^{@}]*)|(?:[^{@}]*{[\s\S]*?}[^{@}]*))*)(\s*@[\w-:( )%&]+\s*{\s*)(?:\s*)(\s*[&\w-.#:[="\]~>+ ,*]*[\w-\]*])(?:\s*{)((?:(?:\s*(?:[\w-]+):[^;]+;)|(?:\s*&[^&{}]+{[\s\S]*?}))*\s*})\s*}/,scope:/((?:^|})\s*)([^&{,}]*(?:{|,))/,separate:/(^)(\s*[^{}]*{)((?:[^{}]*)|(?:[^{}]*{[^{}]*})*)(\s*})/}}static get normalize(){return e=>e.replaceAll(/\s+/g," ").replaceAll(/(\s*)(\{|\}|;)(\s*)/g,"$2 ").replaceAll(DeStyle.regex.nestRegularize,"$1 {$2}")}static get replaceNesting(){return(e,s,t,r,l,n)=>{let o=t.split(","),c=l.split(","),i=[];for(let e in o){let s=o[e];for(let e in c)i.push(c[e].replace("&",s))}return console.log(`${s}${i.join(",")} {${n}${t} {${r}`),`${s}${i.join(",")} {${n}${t} {${r}`}}static get replaceQueries(){return(e,s,t,r,l,n)=>{let o=s.split(","),c=l.split(","),i=[];for(let e in o){let s=o[e];for(let e in c)c[e].replace("&",s)!==i[i.length-1]&&i.push(c[e].replace("&",s))}return`${r}${i.join(",")} {${n}} ${s} {${t}`}}constructor(){this[ELEMENT]=document.createElement("style"),this[ELEMENT].id="de-style",document.head.appendChild(this[ELEMENT]),this[SHEET]=this[ELEMENT].sheet}get insertRule(){return e=>(console.log("inserting:\n"+e),this[SHEET].insertRule(e),"")}insert(e){let s=DeStyle.normalize(e),t=(e,t)=>{for(;s.match(e);)s=s.replace(e,t);return console.log(s),s};return t(DeStyle.regex.queries,DeStyle.replaceQueries),t(DeStyle.regex.cleanup,(()=>"")),t(DeStyle.regex.nestCleanup,(()=>"")),console.log(s),t(DeStyle.regex.nesting,DeStyle.replaceNesting),console.log(s),t(DeStyle.regex.separate,this.insertRule),console.log(s),this}insertScoped(e,s){let t=DeStyle.normalize(s);for(;t.match(DeStyle.regex.scope);)t=t.replace(DeStyle.regex.scope,"$1& $2");return t=`${e} { ${t} }`,console.log(t),this.insert(t)}}export class Style{constructor(){this[ELEMENT]=document.createElement("style"),this[ELEMENT].id="destyle",document.head.appendChild(this[ELEMENT]);let e=Object.create(null);e[SHEET]=this[ELEMENT].sheet,console.log(e),this[RULES]=new Proxy(e,PROXY.style),this[QUERIES]={rules:Object.create(null),new(s){let t=e[SHEET].cssRules.length;e[SHEET].insertRule(s+" {}",t);let r=Object.create(null);return r[SHEET]=e[SHEET].cssRules[t],this.rules[s]=new Proxy(r,PROXY.style),this.rules[s]}}}setStyle(e){let s=(e,s)=>{Object.entries(s).forEach((([r,l])=>{"object"!=typeof l?this[RULES][e](r,l):t(e,s)}))},t=(e,s)=>{this[QUERIES].new(e),Object.entries(s).forEach((([s,t])=>{Object.entries(t).forEach((([t,r])=>{"object"!=typeof r?this[QUERIES].rules[e][s](t,r):tError.e903(r)}))}))};Object.entries(e).forEach((([e,r])=>{console.log(`errHere ${e}::${r}`),e.startsWith("@")?(console.log("errHere"+e+"::"+r),t(e,r)):s(e,r)}))}}